from pymodbus.client.sync import ModbusTcpClient as ModbusClient
class modbus :

    def __init__(self,ip='localhost',port=502):
        FORMAT = ('%(asctime)-15s %(threadName)-15s '
                '%(levelname)-8s %(module)-15s:%(lineno)-8s %(message)s')
        self.UNIT = 0x1
        self.client = ModbusClient(ip, port)
        self.client.connect()
        # self.client.close()

    def read_coil(self,address,count):
        rr = self.client.read_coils(address, count, unit=self.UNIT)
        assert(not rr.isError())     # test that we are not an error

    def write_coil(self,address,value):
        rq = self.client.write_coil(address, value, unit=self.UNIT)
        assert(not rq.isError())     # test that we are not an error

    def write_read_coil(self,address,value,count):
        rq = self.client.write_coils(address, value*count, unit=self.UNIT)
        rr = self.client.read_coils(address, count, unit=self.UNIT)
        assert(not rq.isError())     # test that we are not an error
        assert(not rr.isError())     # test that we are not an error   

    def write_read_coils(self,address,value,count):
        rq = self.client.write_coils(address, value*count, unit=self.UNIT)
        rr = self.client.read_coils(address, count, unit=self.UNIT)
        # print(rr.bits[0])
        assert(not rq.isError())     # test that we are not an error
        assert(not rr.isError())     # test that we are not an error
    
    def read_input(self,address,count):
        rr = self.client.read_discrete_inputs(address, count, unit=self.UNIT)
        assert(not rr.isError())     # test that we are not an error

    def write_read_input(self,address,value,count):
        rq = self.client.write_register(address, value, unit=self.UNIT)
        rr = self.client.read_holding_registers(address, count, unit=self.UNIT)
        assert(not rq.isError())     # test that we are not an error
        assert(not rr.isError())     # test that we are not an error
    
    def write_read_inputs(self,address,value,count):
        rq = self.client.write_registers(address, value*count, unit=self.UNIT)
        rr = self.client.read_holding_registers(address, count, unit=self.UNIT)
        # print(rr.registers[0])
        assert(not rq.isError())     # test that we are not an error
        assert(not rr.isError())     # test that we are not an error

    def read_inputs(self,address,count):
        rr = self.client.read_input_registers(address, count, unit=self.UNIT)
        assert(not rr.isError())     # test that we are not an error

    def write_read_sim_inputs(self,address,value,count):
        arguments = {
            'read_address':    address,
            'read_count':      count,
            'write_address':   address,
            'write_registers': value*count,
        }
        rq = self.client.readwrite_registers(unit=self.UNIT, **arguments)
        rr = self.client.read_holding_registers(address, count, unit=self.UNIT)
        assert(not rq.isError())     # test that we are not an error
        assert(not rr.isError())     # test that we are not an error
